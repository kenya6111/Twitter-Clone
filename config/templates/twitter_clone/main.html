{% extends 'base.html' %}
{% load static %}
{% load sass_tags %}
{% load cloudinary %}

{% block title %}アカウント作成{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{% sass_src 'css/main.scss' %}" />
<style>

</style>
{% endblock %}

{% block content %}
{% if messages %}
{% for message in messages %}
    <div class="alert alert-success" role="alert">{{ message }}
    </div>
{% endfor %}
{% endif %}
<div class="w-100 h-100 bg-top-parent">
    <!-- ヘッダー -->
        {% include 'components/header.html' %}
    <!-- メインコンテンツ -->
    <div class="row menu-container">
        {% include 'components/sidebar.html' %}
        <!-- サイドバー -->
        <!-- センターバー -->
        <div class="col-4 border-gray-side">
            <!-- おすすめorフォロータブ -->
            <nav class="navbar navbar-expand-lg bg-body-tertiary border-gray-bottom h-6">
                <div class="container-fluid h-100">
                    <div class="collapse navbar-collapse h-100" id="navbarNav">
                        <ul class="navbar-nav w-100 h-100">
                            <li id="recommend-tab" class="nav-item w-50 d-flex align-items-center justify-content-center">
                                <a class="nav-link active text-white fw-bold text-center" aria-current="page" href="{% url 'main' %}?filter=foryou">For you</a>
                            </li>
                            <li id="follow-tab" class="nav-item w-50 d-flex align-items-center justify-content-center">
                                <a class="nav-link active text-white fw-bold text-center" href="{% url 'main' %}?filter=follow">Following</a>
                            </li>
                        </ul>
                    </div>
                </div>
            </nav>
            <!-- 投稿エリア -->
            <form action="{% url 'tweet' %}" method="POST" class="h-10 d-flex flex-row border-gray-bottom" enctype="multipart/form-data"> {% csrf_token %}
                <div class="w-7 d-flex justify-content-center align-items-start mt-1 mx-3">
                    <a href="{% url 'profile' %}?user_id={{login_user.id}}">
                        {% cloudinary login_user.image.name class="rounded-circle w-100 h-100" %}
                    </a>
                </div>
                <div class="w-90 h-75 pe-4">
                    <div class="w-100 h-75 border-gray-bottom">
                        <textarea type="textarea" id="post-area" name="tweet-sentence" class="w-100 h-75 fs-5 bg-black border border-black text-white" placeholder="What is happening!?" maxlength="140"></textarea>
                    </div>
                    <div class="d-flex justify-content-between my-2">
                        <div class="d-flex align-items-center">
                            <i class="bi-geo-alt text-primary fs-5 me-3"></i>
                            <i class="bi-calendar text-primary fs-5 me-3"></i>
                            <i class="bi-emoji-smile text-primary fs-5 me-3"></i>
                            <i class="bi-filetype-gif text-primary fs-5 me-3"></i>
                            <label for="file-upload-tweet-image" class="" style="cursor: pointer;">
                                <i class="bi-image text-primary fs-5 me-3"></i>
                            </label>
                            <input type="file" id="file-upload-tweet-image" name="tweet-image" class="d-none">
                            <input type="text" id="user_id" name="user_id" class="d-none" value={{ login_user.id}}>
                        </div>
                        <div class="w-20">
                            <button type="submit" class="btn btn-light rounded-5 fw-bold  fs-6 w-100 btn-lg d-flex align-items-center justify-content-center" tabindex="-1" role="button" aria-disabled="true">
                                Post
                            </button>
                        </div>
                    </div>
                </div>
            </form>
            <!-- タイムライン -->
            {% for article in articles %}
            {% if article.is_retweet %}
                <a href="{% url 'tweet_detail' %}?tweet_id={{article.retweet.id}}">
                    <div class="d-flex flex-row pt-2 border-gray-bottom tweet">
                        <div class="w-7 d-flex justify-content-center align-items-start mt-1 mx-3">
                            <span onClick="moveToProfile('{% url 'profile' %}?user_id={{article.user.id}}',event)">
                                {% cloudinary article.retweet.user.image.name class="rounded-circle w-100 h-100" %}
                            </span>
                        </div>
                        <div class="w-90 h-75 pe-4">
                            <div class="w-100 text-white fs-6 fw-bold">
                                {% if article.is_retweet %}
                                    <p>{{ article.user.username }}がリツイート</p>
                                {% endif %}
                            </div>
                            <div class="text-white fs-5 ">
                                {% if article.retweet.sentense %}
                                    <p class="" style="overflow-wrap: break-word;">{{article.retweet.sentense}}</p>
                                {% endif %}
                            </div>
                            {% if article.retweet.image %}
                            <div>
                                {% cloudinary article.retweet.image.name width=300 height=300 %}
                            </div>
                            {% endif %}
                            <div class="color-gray fs-6 d-flex justify-content-between py-2">
                                <i class="bi-chat"></i>
                                {% if article.retweet.id in retweet_article_ids %}
                                    <i class="bi-arrow-repeat" style="color:green;" onclick="disRetweet(event, {{ article.retweet.id }}, 'main',{{login_user.id}},{{article.id}}, null )">{{article.retweet_retweets_count}}</i>
                                {% else %}
                                    <i class="bi-arrow-repeat" onclick="retweet(event, {{ article.retweet.id }}, 'main',{{login_user.id}}, null )">{{article.retweet_retweets_count}}</i>
                                {% endif %}

                                {% if article.retweet.id in liked_article_ids %}
                                    <i class="bi-heart" style="color:red;" onclick="disLike(event, {{ article.id }}, 'main',{{login_user.id}}, null )"><span class="ms-1">{{article.retweet_likes_count}}</span></i>
                                {% else %}
                                    <i class="bi-heart" onclick="like(event,{{article.id}},'main',{{login_user.id}}, null)"><span class="ms-1">{{article.retweet_likes_count}}</span></i>
                                {% endif %}
                                <i class="bi-bar-chart"></i>
                                <i class="bi-bookmark"></i>
                                <i class="bi-arrow-bar-up"></i>
                            </div>
                        </div>
                        <div class="icons">
                        </div>
                    </div>
                </a>
            {% else %}
                <a href="{% url 'tweet_detail' %}?tweet_id={{article.id}}" class="position-relative">
                    <div class="d-flex flex-row pt-2 border-gray-bottom tweet">
                        <div class="w-7 d-flex justify-content-center align-items-start mt-1 mx-3">
                            <span onClick="moveToProfile('{% url 'profile' %}?user_id={{article.user.id}}',event)">
                                {% cloudinary article.user.image.name class="rounded-circle w-100 h-100" %}
                            </span>
                        </div>
                        <div class="w-90 h-75 pe-4">
                            <div class="w-100 text-white fs-6 fw-bold">
                                {% if article.is_retweet %}
                                    <p>{{ article.user.username }}がリツイート</p>
                                    <p>{{ article.retweet.sentense }}</p>
                                {% else %}
                                <div class="d-flex justify-content-between">
                                    <p>{{ article.user.username}}</p>
                                    <i class="bi bi-three-dots " id="openModal-{{forloop.counter }}" onclick="modalOpen()"></i>
                                    <div id="myModal-{{forloop.counter }}" class="bg-warning modal myModal ">
                                        <div class="">
                                            <span id="closeModal" onclick="modalClose()">✖︎</span>
                                        {% if article.user.id != user.id %}
                                            {% if article.user.id in follower_ids %}
                                                <button class="follow-btn" onclick="followUnfollow({{login_user.id}},{{article.user.id}},'')">{{article.user.username}}さんをアンフォロー</button>
                                            {% else %}
                                                <button class="follow-btn" onclick="followUnfollow({{login_user.id}},{{article.user.id}},true)">{{article.user.username}}さんをフォロー</button>
                                            {% endif %}
                                            <button class="follow-btn" onclick="startMessage({{login_user.id}},{{article.user.id}})">{{article.user.username}}さんにDMを送る</button>
                                        {% endif %}
                                        </div>
                                    </div>
                                    </div>
                                {% endif %}
                            </div>
                            <div class="text-white fs-5 ">
                                {% if article.sentense %}
                                    <p class="" style="overflow-wrap: break-word;">{{article.sentense}}</p>
                                {% endif %}
                            </div>
                            {% if article.image %}
                            <div>
                                {% cloudinary article.image.name width=300 height=300 %}
                            </div>
                            {% endif %}
                            <div class="color-gray fs-6 d-flex justify-content-between py-2">
                                <i class="bi-chat"></i>
                                {% if article.id in retweet_article_ids %}
                                    <i class="bi-arrow-repeat" style="color:green;" onclick="retweet(event, {{ article.id }}, 'main',{{login_user.id}}, null )">{{article.retweets_count}}</i>
                                {% else %}
                                    <i class="bi-arrow-repeat" onclick="retweet(event, {{ article.id }}, 'main',{{login_user.id}}, null )">{{article.retweets_count}}</i>
                                {% endif %}
                                {% if article.id in liked_article_ids %}
                                    <i class="bi-heart" style="color:red;" onclick="disLike(event, {{ article.id }}, 'main',{{login_user.id}}, null )"><span class="ms-1">{{article.likes_count}}</span></i>
                                {% else %}
                                    <i class="bi-heart" onclick="like(event,{{article.id}},'main',{{login_user.id}}, null)"><span class="ms-1">{{article.likes_count}}</span></i>
                                {% endif %}
                                <i class="bi-bar-chart"></i>
                                {% if article.id in bookmark_article_ids %}
                                    <i class="bi-bookmark" style="color:rgb(39, 176, 255);" onclick="bookmark({{ article.id }},{{login_user.id}} )"></i>
                                {% else %}
                                    <i class="bi-bookmark" onclick="bookmark({{ article.id }},{{login_user.id}} )"></i>
                                {% endif %}
                                <i class="bi-arrow-bar-up"></i>
                            </div>
                        </div>
                    </div>
                </a>
            {% endif %}
            {% endfor %}

            <nav aria-label="..." class="mt-3">
                <ul class="pagination d-flex justify-content-center">
                    {% if articles.has_previous %}
                        <li class="page-item">
                            <!-- 前のページへのリンク -->
                            <a href="?p={{ articles.previous_page_number }}" class="page-link">前へ</a>
                        </li>
                    {% endif %}

                    {% for article in articles.paginator.page_range %}
                        <li class="page-item">
                            <a class="page-link" href="?p={{ forloop.counter }}">{{forloop.counter}}</a>
                        </li>
                    {% endfor %}

                    <!-- 次のページへのリンク -->
                    {% if articles.has_next %}
                        <li class="page-item">
                            <a href="?p={{ articles.next_page_number }}" class="page-link">次へ</a>
                        </li>
                    {% endif %}
                </ul>
            </nav>
        <!-- サイドバー（右） -->
        <div class="col-4">
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
<script type="text/javascript" src="{% static 'js/main.js' %}"></script>
{% endblock %}